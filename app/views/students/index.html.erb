<h1>Students</h1>
<h4>Filter:</h4>
<%= form_tag(search_students_path, method: :get) do %>

  <%= label_tag "First name" %>
  <%= text_field_tag :first_name, params[:first_name] %>

  <%= label_tag "Surname" %>
  <%= text_field_tag :last_name, params[:last_name] %>

  <%= label_tag "Prison number" %>
  <%= text_field_tag :prison_number, params[:prison_number] %>

  <%= label_tag "Site" %>
  <%= select_tag :site, options_for_select(Site.order(:name).map { |site| [ site.name, site.name ] } + ["Non listed"], params[:site]), include_blank: true %>

  <%= label_tag "Gender" %>
  <%= select_tag :gender, options_for_select(["","Male","Female"], params[:gender]) %>

  <%= label_tag "Date of birth" %>
  <%= date_field_tag :dob, params[:dob] %>

  <%= label_tag "Released?" %>
  <%= check_box_tag :released?, 1, (params&.dig(:released?) == "1") %>

  <div>
    <%= label_tag "Release between" %>
    <%= date_field_tag :crd_from, params[:crd_from] %>
    <%= date_field_tag :crd_to, params[:crd_to] %>

    <%= label_tag "Tag between" %>
    <%= date_field_tag :hdc_from, params[:hdc_from] %>
    <%= date_field_tag :hdc_to, params[:hdc_to] %>

    <%= label_tag "ROTL between" %>
    <%= date_field_tag :rotl_from, params[:rotl_from] %>
    <%= date_field_tag :rotl_to, params[:rotl_to] %>

    <%= label_tag "Recategorisation between" %>
    <%= date_field_tag :recat_from, params[:recat_from] %>
    <%= date_field_tag :recat_to, params[:recat_to] %>
  </div>

  <div>
    <%= label_tag "Skills" %>
    <%= select_tag :skill_list, options_for_select(Student.tag_counts_on(:skills).collect {|t| [ t.name ] }, params[:skill_list]), { class: "tags", multiple: true } %>

    <%= label_tag "Job preferences" %>
    <%= select_tag :job_preference_list, options_for_select(Student.tag_counts_on(:job_preferences).collect {|t| [ t.name ] }, params[:job_preference_list]), { class: "tags", multiple: true } %>

    <%= label_tag "Tags" %>
    <%= select_tag :tag_list, options_for_select(Student.tag_counts_on(:tags).collect {|t| [ t.name ] }, params[:tag_list]), { class: "tags", multiple: true } %>
  </div>

  <%= submit_tag "Filter" %>

  <%= label_tag "Sort by" %>
  <%= select_tag :sort_by, options_for_select(["First name", "Last name", "Date of birth", "Release date", "Tag date", "ROTL date", "Recategorisation date"], (!params.dig(:sort_by)&.empty? ? params[:sort_by] : "First name")) %>

  <%= label_tag "Order" %>
  <%= select_tag :order, options_for_select(["Ascending", "Descending"], (!params.dig(:order)&.empty? ? params[:order] : "First name")) %>
<% end %>

<div><%= link_to 'View all', students_path %></div>
<div><%= link_to 'Add student', new_student_path if can? :create, Student %></div>

<table class="table">
  <thead>
    <th>Name</th>
    <th>Location</th>
    <th>Relased?</th>
    <th>Prison number</th>
    <th>Date of birth</th>
    <th>Gender</th>
    <th>Release</th>
    <th>Tag</th>
    <th>ROTL</th>
    <th>Recategorisation</th>
    <th>Skills</th>
    <th>Job preferences</th>
    <th>Tags</th>
  </thead>
  <tbody>
    <% @students.each do |student| %>
        <tr>
          <th><%= link_to student.name, student_path(student) %></th>
          <th><%= student.site.present? ? (link_to student.site.name, site_path(student.site)) : "Non listed" %></th>
          <th><%= fa_icon "check" if student.out? %></th>
          <td><%= student.prison_number %></td>
          <td><%= student.dob.present? ? (l student.dob) : "Unknown" %></td>
          <td><%= student.gender %></td>
          <td><%= student.crd.present? ? (l student.crd) : "Unknown" %></td>
          <td><%= student.hdc.present? ? (l student.hdc) : "N/A" %></td>
          <td><%= student.rotl.present? ? (l student.rotl) : "Unknown" %></td>
          <td><%= student.recat.present? ? (l student.recat) : "Unknown" %></td>
          <td><%= student.skill_list %></td>
          <td><%= student.job_preference_list %></td>
          <td><%= student.tag_list %></td>
        </tr>
    <% end %>
  </tbody>
</table>

<% if Student.count == 0 %>
  There are currently no students enrolled on the system.
<% elsif @students.count == 0 %>
  No results found
<% end %>

  <script>
    $(document).on('ready page:load', function () {
      $('.tags').chosen({
        allow_single_deselect: true,
        width: '200px'
      });
    });
  </script>
